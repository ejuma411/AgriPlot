{% extends "listings/admin/base_admin.html" %}
{% load static %}

{% block title %}Complete Task: {{ task.get_verification_type_display }}{% endblock %}

{% block admin_content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <div class="page-header-title">
            <h1><i class="fas fa-check-circle me-2"></i>Complete Task</h1>
            <p class="page-header-subtitle">{{ task.get_verification_type_display }} for {{ plot.title }}</p>
        </div>
        <div class="page-header-actions">
            <a href="{% url 'listings:my_tasks' %}" class="btn">
                <i class="fas fa-arrow-left me-2"></i>Back to My Tasks
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column: Task Info -->
    <div class="col-md-4 mb-4">
        <!-- Task Information Card -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-info-circle me-2"></i>Task Information
                </h5>
            </div>
            <div class="admin-card-body">
                <table class="details-table">
                    <tr>
                        <th>Task Type:</th>
                        <td>
                            <span class="badge 
                                {% if task.verification_type == 'document_review' %}bg-info
                                {% elif task.verification_type == 'extension_review' %}bg-success
                                {% elif task.verification_type == 'surveyor_inspection' %}bg-warning
                                {% endif %} p-2">
                                {{ task.get_verification_type_display }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Assigned:</th>
                        <td>{{ task.assigned_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Time Elapsed:</th>
                        <td>{{ task.assigned_at|timesince }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Plot Details Card -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-map-marker-alt me-2"></i>Plot Details
                </h5>
            </div>
            <div class="admin-card-body">
                <table class="details-table">
                    <tr>
                        <th>Title:</th>
                        <td>{{ plot.title }}</td>
                    </tr>
                    <tr>
                        <th>ID:</th>
                        <td>#{{ plot.id }}</td>
                    </tr>
                    <tr>
                        <th>Location:</th>
                        <td>
                            {% if plot.county %}
                                {{ plot.county }}{% if plot.subcounty %} - {{ plot.subcounty }}{% endif %}
                            {% else %}
                                {{ plot.location }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Area:</th>
                        <td>{{ plot.area }} acres</td>
                    </tr>
                    <tr>
                        <th>Land Type:</th>
                        <td>{{ plot.get_land_type_display }}</td>
                    </tr>
                    <tr>
                        <th>Listing Type:</th>
                        <td>{{ plot.get_listing_type_display }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Document Status Card -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-file-alt me-2"></i>Document Status
                </h5>
            </div>
            <div class="admin-card-body">
                <ul class="document-checklist">
                    <li class="{% if plot.title_deed %}completed{% endif %}">
                        <i class="fas {% if plot.title_deed %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        Title Deed
                        {% if not plot.title_deed %}<small class="text-danger">(Missing)</small>{% endif %}
                    </li>
                    <li class="{% if plot.official_search %}completed{% endif %}">
                        <i class="fas {% if plot.official_search %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        Official Search
                        {% if not plot.official_search %}<small class="text-danger">(Missing)</small>{% endif %}
                    </li>
                    <li class="{% if plot.landowner_id_doc %}completed{% endif %}">
                        <i class="fas {% if plot.landowner_id_doc %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        Landowner ID
                        {% if not plot.landowner_id_doc %}<small class="text-danger">(Missing)</small>{% endif %}
                    </li>
                    <li class="{% if plot.kra_pin %}completed{% endif %}">
                        <i class="fas {% if plot.kra_pin %}fa-check-circle text-success{% else %}fa-times-circle text-danger{% endif %} me-2"></i>
                        KRA PIN
                        {% if not plot.kra_pin %}<small class="text-danger">(Missing)</small>{% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Right Column: Task Completion Form -->
    <div class="col-md-8 mb-4">
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-clipboard-check me-2"></i>Task Completion Form
                </h5>
            </div>
            <div class="admin-card-body">
                <form method="POST" id="completeTaskForm">
                    {% csrf_token %}
                    
                    <!-- Task Type Specific Questions -->
                    {% if task.verification_type == 'document_review' %}
                        <div class="verification-section mb-4">
                            <h6 class="section-subtitle">Document Verification Checklist</h6>
                            <div class="checklist-group">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_title" required>
                                    <label class="form-check-label" for="check_title">
                                        <strong>Title Deed</strong><br>
                                        <small class="text-muted">Verify that the title deed is clear, authentic, and matches the plot details</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_search" required>
                                    <label class="form-check-label" for="check_search">
                                        <strong>Official Search</strong><br>
                                        <small class="text-muted">Verify that the official search is recent (within 3 months) and matches title deed</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_id" required>
                                    <label class="form-check-label" for="check_id">
                                        <strong>Landowner ID</strong><br>
                                        <small class="text-muted">Verify that the ID matches the name on title deed and is valid</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_kra" required>
                                    <label class="form-check-label" for="check_kra">
                                        <strong>KRA PIN</strong><br>
                                        <small class="text-muted">Verify that the KRA PIN matches the landowner's name</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    {% elif task.verification_type == 'extension_review' %}
                        <div class="verification-section mb-4">
                            <h6 class="section-subtitle">Agricultural Assessment</h6>
                            <div class="mb-3">
                                <label class="form-label">Soil Type Verification</label>
                                <select class="form-select" name="soil_verified" required>
                                    <option value="">Select...</option>
                                    <option value="yes">‚úÖ Confirmed - Matches description</option>
                                    <option value="partial">‚ö†Ô∏è Partial Match - Some discrepancies</option>
                                    <option value="no">‚ùå Does Not Match</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Crop Suitability Assessment</label>
                                <select class="form-select" name="crop_assessment" required>
                                    <option value="">Select...</option>
                                    <option value="excellent">üåü Excellent for stated crops</option>
                                    <option value="good">üëç Good for stated crops</option>
                                    <option value="fair">üëå Fair - Some limitations</option>
                                    <option value="poor">üëé Poor - Not suitable</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Recommendations</label>
                                <textarea class="form-control" name="crop_recommendations" rows="3" 
                                          placeholder="Suggest alternative crops or improvements..."></textarea>
                            </div>
                        </div>
                    {% elif task.verification_type == 'surveyor_inspection' %}
                        <div class="verification-section mb-4">
                            <h6 class="section-subtitle">Site Inspection Form</h6>
                            <div class="mb-3">
                                <label class="form-label">GPS Coordinates Verification</label>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <div class="input-group">
                                            <span class="input-group-text">Lat</span>
                                            <input type="text" class="form-control" name="verified_lat" placeholder="{{ plot.latitude }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <div class="input-group">
                                            <span class="input-group-text">Lng</span>
                                            <input type="text" class="form-control" name="verified_lng" placeholder="{{ plot.longitude }}">
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Enter actual GPS readings from site visit</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Boundary Confirmation</label>
                                <select class="form-select" name="boundary_status" required>
                                    <option value="">Select...</option>
                                    <option value="clear">‚úÖ Clear boundaries - Marked/Beaconed</option>
                                    <option value="partial">‚ö†Ô∏è Partially clear - Needs demarcation</option>
                                    <option value="dispute">‚ùå Boundary dispute suspected</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Site Photos</label>
                                <input type="file" class="form-control" name="site_photos" multiple accept="image/*">
                                <small class="text-muted">Upload photos from site visit</small>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Common Fields -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Task Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="4" 
                                  placeholder="Enter your findings, observations, and recommendations..." required></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label d-block">Decision</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="approved" id="approve" value="true" autocomplete="off" required>
                            <label class="btn btn-outline-success" for="approve">
                                <i class="fas fa-check-circle me-2"></i>Approve
                            </label>

                            <input type="radio" class="btn-check" name="approved" id="reject" value="false" autocomplete="off">
                            <label class="btn btn-outline-danger" for="reject">
                                <i class="fas fa-times-circle me-2"></i>Reject
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="submitText">Submit Task Completion</span>
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                        <a href="{% url 'listings:my_tasks' %}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .details-table {
        width: 100%;
    }

    .details-table th {
        text-align: left;
        padding: 0.5rem 0;
        color: var(--secondary);
        font-weight: 500;
        width: 40%;
    }

    .details-table td {
        padding: 0.5rem 0;
    }

    .document-checklist {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .document-checklist li {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
    }

    .document-checklist li:last-child {
        border-bottom: none;
    }

    .verification-section {
        background: var(--light);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .section-subtitle {
        color: var(--primary);
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .checklist-group {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .form-check {
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .form-check-input:checked {
        background-color: var(--success);
        border-color: var(--success);
    }

    .btn-group {
        gap: 0.5rem;
    }

    .btn-group .btn {
        border-radius: 8px !important;
        padding: 1rem;
    }

    .input-group-text {
        background: var(--light);
        border: 1px solid #e9ecef;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('completeTaskForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    {% if task.verification_type == 'document_review' %}
    // Validate that all checkboxes are checked for document review
    form.addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('.form-check-input');
        let allChecked = true;
        
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                allChecked = false;
            }
        });
        
        if (!allChecked) {
            e.preventDefault();
            alert('Please confirm all document checks before completing the task.');
            return false;
        }
    });
    {% endif %}
    
    // Show loading state on submit
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitText.textContent = 'Submitting...';
        loadingSpinner.classList.remove('d-none');
    });
});
</script>
{% endblock %}