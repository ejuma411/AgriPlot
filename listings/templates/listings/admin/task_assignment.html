{% extends "listings/admin/base_admin.html" %}
{% load static %}

{% block title %}Task Assignment - AgriPlot Admin{% endblock %}

{% block admin_content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <div class="page-header-title">
            <h1><i class="fas fa-tasks me-2"></i>Task Assignment</h1>
            <p class="page-header-subtitle">Manage verification workflow</p>
        </div>
        <div class="page-header-actions">
            <a href="{% url 'listings:verification_dashboard' %}" class="btn">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-value">{{ task_stats.pending|default:0 }}</div>
        <div class="stat-label">Pending Tasks</div>
        <div class="stat-trend">
            <span>Awaiting assignment</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-sync-alt"></i></div>
        <div class="stat-value">{{ task_stats.in_progress|default:0 }}</div>
        <div class="stat-label">In Progress</div>
        <div class="stat-trend">
            <span>Currently being worked on</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value">{{ task_stats.completed_today|default:0 }}</div>
        <div class="stat-label">Completed Today</div>
        <div class="stat-trend">
            <span class="trend-up"><i class="fas fa-arrow-up"></i> Tasks finished</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-value">{{ task_stats.overdue|default:0 }}</div>
        <div class="stat-label">Overdue</div>
        <div class="stat-trend">
            <span class="trend-down">Taking > 2 days</span>
        </div>
    </div>
</div>

<!-- Tasks by Type & Staff Workload -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-chart-pie me-2"></i>Pending Tasks by Type
                </h5>
            </div>
            <div class="admin-card-body">
                <div class="task-type-list">
                    {% for type, count in task_stats.by_type.items %}
                        <div class="task-stat-item">
                            <span class="task-stat-label">
                                {% if type == 'document_review' %}
                                    <i class="fas fa-file-alt me-2 text-info"></i>Document Review
                                {% elif type == 'extension_review' %}
                                    <i class="fas fa-leaf me-2 text-success"></i>Extension Review
                                {% elif type == 'surveyor_inspection' %}
                                    <i class="fas fa-ruler me-2 text-warning"></i>Surveyor Inspection
                                {% endif %}
                            </span>
                            <span class="task-stat-value">{{ count }}</span>
                        </div>
                    {% empty %}
                        <p class="text-muted text-center">No pending tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="admin-card-title">
                    <i class="fas fa-users me-2"></i>Staff Workload
                </h5>
            </div>
            <div class="admin-card-body">
                <div class="workload-list">
                    {% for staff in workload %}
                        <div class="task-stat-item">
                            <div class="staff-info">
                                <strong>{{ staff.user.get_full_name|default:staff.user.username }}</strong>
                                <small class="text-muted d-block">{{ staff.total_assigned }} total assigned</small>
                            </div>
                            <div class="staff-stats">
                                <span class="badge bg-warning me-1">{{ staff.pending }} active</span>
                                <span class="badge bg-success">{{ staff.completed_today }} today</span>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted text-center">No staff members found</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Tasks Queue -->
<div class="admin-card mb-4">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-hourglass-half me-2" style="color: #ffc107;"></i>
            Pending Tasks ({{ pending_tasks|length }})
        </h5>
    </div>
    <div class="admin-card-body">
        {% if pending_tasks %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Task Type</th>
                        <th>Plot</th>
                        <th>Location</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in pending_tasks %}
                    <tr>
                        <td>
                            <span class="badge 
                                {% if task.verification_type == 'document_review' %}bg-info
                                {% elif task.verification_type == 'extension_review' %}bg-success
                                {% elif task.verification_type == 'surveyor_inspection' %}bg-warning
                                {% endif %} p-2">
                                {{ task.get_verification_type_display }}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'listings:plot_detail' task.plot.id %}" target="_blank">
                                {{ task.plot.title|truncatechars:30 }}
                            </a>
                        </td>
                        <td>{{ task.plot.county|default:task.plot.location|truncatechars:20 }}</td>
                        <td>{{ task.assigned_at|timesince }} ago</td>
                        <td>
                            <button class="btn btn-sm btn-success assign-btn" 
                                    data-task-id="{{ task.id }}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#assignModal">
                                <i class="fas fa-user-plus me-1"></i> Assign
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <p class="text-muted">No pending tasks</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- In Progress Tasks -->
<div class="admin-card">
    <div class="admin-card-header">
        <h5 class="admin-card-title">
            <i class="fas fa-sync-alt fa-spin me-2"></i>
            In Progress Tasks ({{ in_progress_tasks|length }})
        </h5>
    </div>
    <div class="admin-card-body">
        {% if in_progress_tasks %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Task Type</th>
                        <th>Plot</th>
                        <th>Assigned To</th>
                        <th>Assigned</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in in_progress_tasks %}
                    <tr>
                        <td>
                            <span class="badge 
                                {% if task.verification_type == 'document_review' %}bg-info
                                {% elif task.verification_type == 'extension_review' %}bg-success
                                {% elif task.verification_type == 'surveyor_inspection' %}bg-warning
                                {% endif %} p-2">
                                {{ task.get_verification_type_display }}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'listings:plot_detail' task.plot.id %}" target="_blank">
                                {{ task.plot.title|truncatechars:30 }}
                            </a>
                        </td>
                        <td>
                            <i class="fas fa-user me-1"></i>
                            {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        </td>
                        <td>{{ task.assigned_at|timesince }} ago</td>
                        <td>
                            <a href="{% url 'listings:review_plot' task.plot.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-3">No tasks in progress</p>
        {% endif %}
    </div>
</div>

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignForm">
                    {% csrf_token %}
                    <input type="hidden" name="task_id" id="taskIdInput">
                    
                    <div class="mb-3">
                        <label for="staffSelect" class="form-label">Select Staff Member</label>
                        <select class="form-select" id="staffSelect" required>
                            <option value="">Choose...</option>
                            {% for user in staff_users %}
                                <option value="{{ user.id }}">
                                    {{ user.get_full_name|default:user.username }}
                                    {% if user.email %} - {{ user.email }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAssignBtn">
                    <i class="fas fa-check me-1"></i> Assign Task
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .task-type-list, .workload-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .task-stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--light);
        border-radius: 6px;
    }

    .staff-info {
        flex: 1;
    }

    .staff-stats {
        display: flex;
        gap: 0.25rem;
    }

    .btn-group {
        display: flex;
        gap: 0.25rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle assign button clicks
    const assignBtns = document.querySelectorAll('.assign-btn');
    const taskIdInput = document.getElementById('taskIdInput');
    const staffSelect = document.getElementById('staffSelect');
    const confirmBtn = document.getElementById('confirmAssignBtn');
    
    assignBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const taskId = this.dataset.taskId;
            taskIdInput.value = taskId;
        });
    });
    
    // Handle assignment confirmation
    confirmBtn.addEventListener('click', function() {
        const taskId = taskIdInput.value;
        const userId = staffSelect.value;
        
        if (!userId) {
            alert('Please select a staff member');
            return;
        }
        
        fetch('{% url "listings:ajax_assign_task" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                task_id: taskId,
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    });
});
</script>
{% endblock %}