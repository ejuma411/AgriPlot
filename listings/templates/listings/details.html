{% extends "base.html" %}
{% load static %}

{% block title %}{{ plot.title }} — AgriPlot Connect{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-header">
                <div class="dashboard-header-content">
                    <div class="dashboard-title">
                        <h2>{{ plot.title }}</h2>
                        <p class="dashboard-subtitle">Plot ID: #{{ plot.id }} • {{ plot.location }}</p>
                    </div>
                    <div class="dashboard-stats-summary">
                        <div class="stat-badge">
                            <span class="stat-badge-value text-primary">KES {{ plot.price|floatformat:0 }}</span>
                            <span class="stat-badge-label">Price</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-badge-value text-success">{{ plot.area|floatformat:1 }}</span>
                            <span class="stat-badge-label">Acres</span>
                        </div>
                        <div class="stat-badge">
                            <span class="stat-badge-value">
                                {% if plot.verification_status.status == 'verified' %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% else %}
                                <i class="fas fa-clock text-warning"></i>
                                {% endif %}
                            </span>
                            <span class="stat-badge-label">
                                {% if plot.verification_status.status == 'verified' %}Verified{% else %}Pending{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="detail-navigation">
                <a href="{% url 'listings:home' %}" class="nav-link">
                    <i class="fas fa-arrow-left me-2"></i>Back to Listings
                </a>
                <a href="#details" class="nav-link active">Details</a>
                <a href="#images" class="nav-link">Images</a>
                <a href="#documents" class="nav-link">Documents</a>
                <a href="#broker" class="nav-link">Broker</a>
            </nav>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row">
        <!-- Left Column: Images Gallery -->
        <div class="col-lg-8 mb-4">
            <!-- Image Gallery -->
            <div class="dashboard-card mb-4" id="images">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-images me-2"></i>Plot Images
                    </h6>
                </div>
                <div class="card-body">
                    {% if plot.images_list.exists %}
                    <div class="image-gallery">
                        <div class="gallery-hover">
                            {% for img in plot.images_list.all %}
                            <img src="{{ img.image.url }}" 
                                alt="{{ plot.title }} - image {{ forloop.counter }}"
                                class="{% if forloop.first %}active{% endif %}">
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-gallery text-center py-5">
                        <i class="fas fa-image fa-4x text-muted mb-3"></i>
                        <h5>No Images Available</h5>
                        <p class="text-muted mb-0">This plot doesn't have any images yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Plot Details Table -->
            <div class="dashboard-card" id="details">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>Plot Details
                    </h6>
                </div>
                <div class="card-body">
                    <div class="details-table">
                        <table class="plot-details-table">
                            <tbody>
                                <tr>
                                    <td class="detail-label">Title</td>
                                    <td class="detail-value">{{ plot.title }}</td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Location</td>
                                    <td class="detail-value">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                        {{ plot.location }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Area</td>
                                    <td class="detail-value">
                                        <i class="fas fa-ruler-combined text-warning me-2"></i>
                                        {{ plot.area|floatformat:1 }} Acres
                                    </td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Price</td>
                                    <td class="detail-value">
                                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                                        KES {{ plot.price|floatformat:0 }}
                                        {% if plot.area and plot.area > 0 %}
                                        <small class="text-muted d-block mt-1">
                                            (KES {% widthratio plot.price plot.area 1 as price_per_acre %}{{ price_per_acre|floatformat:0 }} per acre)
                                        </small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Soil Type</td>
                                    <td class="detail-value">
                                        <i class="fas fa-seedling text-success me-2"></i>
                                        {{ plot.soil_type|default:"Not specified" }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Crop Suitability</td>
                                    <td class="detail-value">
                                        <i class="fas fa-leaf text-info me-2"></i>
                                        {{ plot.crop_suitability|default:"Various crops" }}
                                    </td>
                                </tr>
                                {% if plot.ph_level %}
                                <tr>
                                    <td class="detail-label">pH Level</td>
                                    <td class="detail-value">
                                        <i class="fas fa-flask text-primary me-2"></i>
                                        {{ plot.ph_level }}
                                        <span class="ph-indicator 
                                            {% if plot.ph_level < 5 %}text-danger{% elif plot.ph_level > 8 %}text-warning{% else %}text-success{% endif %}">
                                            {% if plot.ph_level < 5 %}(Acidic){% elif plot.ph_level > 8 %}(Alkaline){% else %}(Neutral){% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td class="detail-label">Verification Status</td>
                                    <td class="detail-value">
                                        {% if plot.verification_status.status == 'verified' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Verified
                                        </span>
                                        {% elif plot.verification_status.status == 'pending' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                        {% elif plot.verification_status.status == 'rejected' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times-circle me-1"></i>Rejected
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            {{ plot.verification_status.status|title }}
                                        </span>
                                        {% endif %}
                                        {% if plot.verification_status.reviewed_at %}
                                        <small class="text-muted d-block mt-1">
                                            Reviewed: {{ plot.verification_status.reviewed_at|date:"M d, Y" }}
                                        </small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="detail-label">Date Listed</td>
                                    <td class="detail-value">
                                        <i class="fas fa-calendar text-primary me-2"></i>
                                        {{ plot.created_at|date:"F d, Y" }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Documents & Broker Info -->
        <div class="col-lg-4 mb-4">
            <!-- Documents -->
            <div class="dashboard-card mb-4" id="documents">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-file-alt me-2"></i>Documents
                    </h6>
                </div>
                <div class="card-body">
                    <div class="documents-list">
                        <div class="document-item {% if plot.title_deed %}available{% else %}missing{% endif %}">
                            <div class="document-icon">
                                <i class="fas fa-file-contract fa-2x"></i>
                            </div>
                            <div class="document-info">
                                <h6>Title Deed</h6>
                                {% if plot.title_deed %}
                                <a href="{{ plot.title_deed.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i>View Document
                                </a>
                                {% else %}
                                <small class="text-muted">Not uploaded</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="document-item {% if plot.soil_report %}available{% else %}missing{% endif %}">
                            <div class="document-icon">
                                <i class="fas fa-flask fa-2x"></i>
                            </div>
                            <div class="document-info">
                                <h6>Soil Test Report</h6>
                                {% if plot.soil_report %}
                                <a href="{{ plot.soil_report.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-download me-1"></i>View Report
                                </a>
                                {% else %}
                                <small class="text-muted">Optional - Not uploaded</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broker Information & Contact -->
            <div class="dashboard-card mb-4" id="broker">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-user-tie me-2"></i>Broker Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="broker-profile">
                        <div class="broker-header">
                            <div class="broker-avatar">
                                {% if plot.broker.profile_picture %}
                                <img src="{{ plot.broker.profile_picture.url }}" 
                                    alt="{{ plot.broker.user.get_full_name }}" 
                                    class="avatar-img">
                                {% else %}
                                <div class="avatar-placeholder">
                                    {{ plot.broker.user.get_full_name|default:plot.broker.user.username|first|upper }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="broker-name">
                                <h5>{{ plot.broker.user.get_full_name|default:plot.broker.user.username }}</h5>
                                <span class="broker-badge {% if plot.broker.verified %}verified{% else %}pending{% endif %}">
                                    {% if plot.broker.verified %}
                                    <i class="fas fa-check-circle me-1"></i>Verified Broker
                                    {% else %}
                                    <i class="fas fa-clock me-1"></i>Pending Verification
                                    {% endif %}
                                </span>
                                {% if plot.broker.rating %}
                                <div class="broker-rating">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= plot.broker.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <small class="text-muted ms-1">({{ plot.broker.review_count }})</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Broker Stats -->
                        <div class="broker-stats mt-3">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <i class="fas fa-layer-group text-primary"></i>
                                    <div>
                                        <strong>{{ plot.broker.total_listings|default:"0" }}</strong>
                                        <small>Listings</small>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <div>
                                        <strong>{{ plot.broker.verified_listings|default:"0" }}</strong>
                                        <small>Verified</small>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-clock text-warning"></i>
                                    <div>
                                        <strong>{{ plot.broker.response_rate|default:"100" }}%</strong>
                                        <small>Response Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Direct Contact Section -->
                        <div class="broker-contact mt-4">
                            <h6>Contact Broker</h6>
                            
                            {% if user.is_authenticated %}
                            <div class="contact-methods">
                                <!-- Email -->
                                <a href="mailto:{{ plot.broker.user.email }}?subject=Inquiry about {{ plot.title|urlencode }}&body=Hello {{ plot.broker.user.get_full_name|default:plot.broker.user.username }},%0D%0A%0D%0AI'm interested in your plot titled '{{ plot.title }}' (ID: #{{ plot.id }}) located at {{ plot.location }}.%0D%0A%0D%0APlease provide more details about:%0D%0A1. Availability%0D%0A2. Viewing arrangements%0D%0A3. Payment terms%0D%0A%0D%0AThank you,%0D%0A{{ user.get_full_name|default:user.username }}"
                                class="btn btn-outline-primary w-100 mb-2">
                                    <i class="fas fa-envelope me-2"></i>Send Email
                                    <small class="d-block text-muted mt-1">{{ plot.broker.user.email }}</small>
                                </a>
                                
                                <!-- Phone (if available) -->
                                {% if plot.broker.phone_number %}
                                <div class="phone-contact mb-2">
                                    <button class="btn btn-success w-100" id="showPhoneNumber">
                                        <i class="fas fa-phone me-2"></i>Show Phone Number
                                    </button>
                                    <div id="phoneNumber" class="text-center mt-2 d-none">
                                        <strong>{{ plot.broker.phone_number }}</strong>
                                        <div class="btn-group mt-2 w-100">
                                            <a href="tel:{{ plot.broker.phone_number }}" 
                                            class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-phone me-1"></i>Call
                                            </a>
                                            <a href="https://wa.me/{{ plot.broker.phone_number|cut:'+' }}?text=Hello {{ plot.broker.user.get_full_name|default:plot.broker.user.username }}, I'm interested in your plot '{{ plot.title }}' (ID: #{{ plot.id }})"
                                            class="btn btn-sm btn-outline-success" 
                                            target="_blank">
                                                <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                            </a>
                                            <a href="sms:{{ plot.broker.phone_number }}?body=Hello, I'm interested in your plot '{{ plot.title }}' (ID: #{{ plot.id }})"
                                            class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-sms me-1"></i>SMS
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <button class="btn btn-outline-secondary w-100 mb-2" 
                                        onclick="requestContactDetails()">
                                    <i class="fas fa-phone me-2"></i>Request Phone Number
                                </button>
                                {% endif %}
                                
                                <!-- Contact Form Modal -->
                                <div class="modal fade" id="contactFormModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form id="contactForm" method="POST" action="{% url 'listings:contact_broker' plot.id %}">
                                                {% csrf_token %}
                                                <div class="modal-header">
                                                    <h5 class="modal-title">
                                                        <i class="fas fa-paper-plane me-2"></i>Message Broker
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="messageSubject" class="form-label">Subject</label>
                                                        <input type="text" class="form-control" id="messageSubject" 
                                                            value="Inquiry about {{ plot.title }}" readonly>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="messageBody" class="form-label">Your Message</label>
                                                        <textarea class="form-control" id="messageBody" rows="6" required
                                                                placeholder="Write your message here..."></textarea>
                                                        <div class="form-text">
                                                            Include specific questions about price, location, soil quality, etc.
                                                        </div>
                                                    </div>
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        Your contact information (email: {{ user.email }}) will be shared with the broker.
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-paper-plane me-2"></i>Send Message
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Visit Modal -->
                                <div class="modal fade" id="scheduleVisitModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form id="visitForm">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">
                                                        <i class="fas fa-calendar-check me-2"></i>Schedule Site Visit
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="visitDate" class="form-label">Preferred Date</label>
                                                        <input type="date" class="form-control" id="visitDate" required 
                                                            min="{{ today|date:'Y-m-d' }}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="visitTime" class="form-label">Preferred Time</label>
                                                        <select class="form-select" id="visitTime" required>
                                                            <option value="">Select time</option>
                                                            <option value="08:00">8:00 AM</option>
                                                            <option value="09:00">9:00 AM</option>
                                                            <option value="10:00">10:00 AM</option>
                                                            <option value="11:00">11:00 AM</option>
                                                            <option value="12:00">12:00 PM</option>
                                                            <option value="13:00">1:00 PM</option>
                                                            <option value="14:00">2:00 PM</option>
                                                            <option value="15:00">3:00 PM</option>
                                                            <option value="16:00">4:00 PM</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="visitNotes" class="form-label">Additional Notes</label>
                                                        <textarea class="form-control" id="visitNotes" rows="3" 
                                                                placeholder="Any special requirements or questions..."></textarea>
                                                    </div>
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        The broker will confirm the visit via email/phone.
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-calendar-plus me-2"></i>Request Visit
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Schedule Visit -->
                                <button class="btn btn-outline-success w-100" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#scheduleVisitModal">
                                    <i class="fas fa-calendar-check me-2"></i>Schedule Site Visit
                                </button>
                            </div>
                            {% else %}
                            <div class="guest-contact">
                                <p class="text-muted mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    You need to be logged in to contact the broker
                                </p>
                                <a href="{% url 'login' %}?next={{ request.path }}" 
                                class="btn btn-primary w-100 mb-2">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login to Contact
                                </a>
                                <a href="{% url 'register' %}?next={{ request.path }}" 
                                class="btn btn-outline-primary w-100">
                                    <i class="fas fa-user-plus me-2"></i>Create Account
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="quick-actions-grid">
                        {% if user.is_authenticated %}
                            {% if user == plot.broker.user %}
                            <a href="{% url 'listings:edit_plot' plot.id %}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-edit me-2"></i>Edit Listing
                            </a>
                            {% endif %}
                            <a href="{% url 'listings:add_plot' %}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-plus-circle me-2"></i>List Similar Plot
                            </a>
                        {% else %}
                            <a href="{% url 'register' %}?next={{ request.path }}" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-user-plus me-2"></i>Register to Contact
                            </a>
                            <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-phone me-2"></i>Contact Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>To protect broker privacy, phone numbers are shared upon request through our secure system.</p>
                <p>Click the button below to request the broker's contact information:</p>
                <button class="btn btn-success w-100" id="requestContactBtn">
                    <i class="fas fa-paper-plane me-2"></i>Request Contact Details
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* =========================
   GLOBAL STYLES
========================= */
body {
    font-family: 'Inter', sans-serif;
    background: #f8f9fa;
    color: #333;
    line-height: 1.6;
}

h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

p {
    margin-bottom: 1rem;
    color: #4b5563;
}

a {
    text-decoration: none;
    transition: all 0.3s ease;
}

a:hover {
    text-decoration: none;
    color: #1f7a4d;
}

.container-fluid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

/* =========================
   DASHBOARD HEADER
========================= */
.dashboard-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.dashboard-header-content {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.dashboard-title h2 {
    font-size: 2rem;
}

.dashboard-subtitle {
    color: #6b7280;
    font-size: 0.95rem;
}

.dashboard-stats-summary {
    display: flex;
    gap: 1.5rem;
}

.stat-badge {
    text-align: center;
}

.stat-badge-value {
    font-size: 1.25rem;
    font-weight: 600;
    display: block;
}

.stat-badge-label {
    font-size: 0.85rem;
    color: #6b7280;
}

/* =========================
   NAVIGATION
========================= */
.detail-navigation {
    display: flex;
    gap: 1rem;
    background: #fff;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow-x: auto;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    color: #4b5563;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
    background-color: #1f7a4d;
    color: #fff;
}

/* =========================
   DASHBOARD CARDS
========================= */
.dashboard-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f3f4f6;
}

.card-title {
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1rem 1.5rem;
}

/* =========================
   IMAGE GALLERY
========================= */
.image-gallery {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.gallery-hover {
    width: 100%;
    height: 400px;
    border-radius: 14px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
    position: relative;
}

.gallery-hover img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease, transform 0.4s ease;
    border-radius: 14px;
}

.gallery-hover img.active {
    opacity: 1;
}

.gallery-hover img:hover {
    transform: scale(1.05);
}

.thumbnail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.thumbnail-item {
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid #e5e7eb;
    height: 70px;
    transition: all 0.3s ease;
}

.thumbnail-item.active,
.thumbnail-item:hover {
    border-color: #1f7a4d;
    transform: translateY(-2px);
}

.thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Empty gallery placeholder */
.empty-gallery {
    text-align: center;
    padding: 3rem;
    background: #f9fafb;
    border-radius: 12px;
    border: 2px dashed #d1d5db;
}

/* =========================
   PLOT DETAILS TABLE
========================= */
.plot-details-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.plot-details-table tr {
    border-bottom: 1px solid #e5e7eb;
    transition: background 0.3s ease;
}

.plot-details-table tr:hover {
    background-color: #f9fafb;
}

.plot-details-table td {
    padding: 1rem;
    vertical-align: top;
}

.detail-label {
    width: 35%;
    font-weight: 600;
    color: #374151;
    border-right: 1px solid #e5e7eb;
}

.detail-value {
    width: 65%;
    color: #1f2937;
}

.ph-indicator {
    margin-left: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
}

/* =========================
   DOCUMENTS
========================= */
.documents-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.document-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    border: 2px solid;
    align-items: center;
    transition: all 0.3s ease;
}

.document-item.available {
    border-color: #10b981;
    background: #d1fae5;
}

.document-item.missing {
    border-color: #d1d5db;
    background: #f3f4f6;
}

.document-icon {
    flex-shrink: 0;
    font-size: 1.75rem;
}

.document-info h6 {
    margin-bottom: 0.25rem;
    font-weight: 600;
    color: #1f2937;
}

/* =========================
   BROKER PROFILE
========================= */
.broker-profile {
    text-align: center;
}

.broker-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.broker-avatar {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-radius: 50%;
}

.broker-name h5 {
    margin-bottom: 0.25rem;
    color: #1f2937;
}

.broker-badge {
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 500;
}

.broker-badge.verified {
    background: #d1fae5;
    color: #065f46;
}

.broker-badge.pending {
    background: #fef3c7;
    color: #92400e;
}

.broker-contact h6 {
    margin-bottom: 0.75rem;
}

/* =========================
   BUTTONS
========================= */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: #1f7a4d;
    color: #fff;
    border: none;
}

.btn-primary:hover {
    background-color: #16603a;
}

.btn-outline-primary {
    background: transparent;
    color: #1f7a4d;
    border: 2px solid #1f7a4d;
}

.btn-outline-primary:hover {
    background-color: #1f7a4d;
    color: #fff;
}

.btn-success {
    background-color: #10b981;
    color: #fff;
    border: none;
}

.btn-success:hover {
    background-color: #059669;
}

.btn-outline-warning {
    background: transparent;
    color: #f59e0b;
    border: 2px solid #f59e0b;
}

.btn-outline-warning:hover {
    background-color: #f59e0b;
    color: #fff;
}

/* =========================
   RESPONSIVE
========================= */
@media (max-width: 992px) {
    .main-image-container,
    .gallery-hover {
        height: 300px;
    }
}

@media (max-width: 768px) {
    .dashboard-header-content {
        flex-direction: column;
        gap: 1rem;
    }
    .plot-details-table {
        display: block;
    }
    .plot-details-table tr {
        display: block;
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }
    .plot-details-table td {
        display: block;
        width: 100%;
        border: none;
        padding: 0.25rem 0;
    }
    .detail-label {
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    .dashboard-title h2 {
        font-size: 1.5rem;
    }
    .main-image-container,
    .gallery-hover {
        height: 200px;
    }
    .thumbnail-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    .document-item {
        flex-direction: column;
        text-align: center;
    }
    .broker-header {
        flex-direction: column;
        text-align: center;
    }
}

/* =========================
   BROKER CONTACT ENHANCEMENTS
========================= */
.broker-avatar .avatar-img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #1f7a4d;
}

.broker-avatar .avatar-placeholder {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #1f7a4d, #10b981);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    border: 3px solid #1f7a4d;
}

.broker-rating {
    margin-top: 0.5rem;
}

.broker-stats {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 0.5rem;
}

.stat-item i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    display: block;
}

.stat-item strong {
    display: block;
    font-size: 1.25rem;
    color: #1f2937;
}

.stat-item small {
    font-size: 0.8rem;
    color: #6b7280;
}

.contact-methods .btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    text-align: center;
}

.btn-group {
    display: flex;
    gap: 0.5rem;
}

.btn-group .btn {
    flex: 1;
}

.guest-contact {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

/* =========================
   CONTACT MODALS
========================= */
.modal-content {
    border-radius: 12px;
    border: none;
}

.modal-header {
    background: #1f7a4d;
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-header .btn-close {
    filter: invert(1);
}

.form-text {
    font-size: 0.85rem;
    color: #6b7280;
}

/* =========================
   RESPONSIVE IMPROVEMENTS
========================= */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .broker-stats {
        padding: 0.75rem;
    }
    
    .contact-methods .btn {
        padding: 0.75rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Image gallery functionality
        const thumbnails = document.querySelectorAll('.thumbnail-item');
        const mainImage = document.getElementById('mainImage');
        
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                // Update active class
                thumbnails.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update main image
                const imageUrl = this.getAttribute('data-image');
                if (mainImage && imageUrl) {
                    mainImage.src = imageUrl;
                    mainImage.alt = this.querySelector('img').alt;
                }
            });
        });
        
        // Contact modal
        const showContactBtn = document.getElementById('showContactBtn');
        const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
        const requestContactBtn = document.getElementById('requestContactBtn');
        
        if (showContactBtn) {
            showContactBtn.addEventListener('click', function() {
                contactModal.show();
            });
        }
        
        if (requestContactBtn) {
            requestContactBtn.addEventListener('click', function() {
                // In a real application, this would send a request to the server
                alert('Contact request sent to broker. They will contact you shortly.');
                contactModal.hide();
            });
        }
        
        // Smooth scroll for navigation
        document.querySelectorAll('.nav-link[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId !== '#') {
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        // Update active nav link
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Scroll to element
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });
        
        // Update active nav link on scroll
        const sections = document.querySelectorAll('[id]');
        const navLinks = document.querySelectorAll('.nav-link[href^="#"]');
        
        function updateActiveNavLink() {
            let currentSection = '';
            const scrollPosition = window.scrollY + 100;
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                    currentSection = '#' + section.id;
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentSection) {
                    link.classList.add('active');
                }
            });
        }
        
        window.addEventListener('scroll', updateActiveNavLink);
        updateActiveNavLink(); // Initial call
    });

document.addEventListener('DOMContentLoaded', function() {
    const galleries = document.querySelectorAll('.gallery-hover');

    galleries.forEach(gallery => {
        const images = gallery.querySelectorAll('img');
        let index = 0;
        let interval;

        // Hover cycling for desktop
        gallery.addEventListener('mouseenter', () => {
            if (images.length <= 1) return;
            interval = setInterval(() => {
                images[index].classList.remove('active');
                index = (index + 1) % images.length;
                images[index].classList.add('active');
            }, 1000);
        });

        gallery.addEventListener('mouseleave', () => {
            clearInterval(interval);
            images.forEach(img => img.classList.remove('active'));
            images[0].classList.add('active');
            index = 0;
        });

        // Swipe for mobile
        let startX = 0;
        let endX = 0;

        gallery.addEventListener('touchstart', e => { startX = e.touches[0].clientX; clearInterval(interval); });
        gallery.addEventListener('touchmove', e => { endX = e.touches[0].clientX; });
        gallery.addEventListener('touchend', () => {
            const diff = startX - endX;
            if (Math.abs(diff) > 30) {
                images[index].classList.remove('active');
                if (diff > 0) index = (index + 1) % images.length;
                else index = (index - 1 + images.length) % images.length;
                images[index].classList.add('active');
            }
        });

        // Thumbnail click
        const thumbnails = gallery.parentElement.querySelectorAll('.thumbnail-item');
        thumbnails.forEach(thumb => {
            thumb.addEventListener('click', function() {
                images.forEach(img => img.classList.remove('active'));
                thumbnails.forEach(t => t.classList.remove('active'));
                const imgUrl = this.getAttribute('data-image');
                images.forEach(img => {
                    if (img.src.includes(imgUrl)) img.classList.add('active');
                });
                this.classList.add('active');
            });
        });
    });
});

// Simplified contact functionality - less prone to errors
document.addEventListener('DOMContentLoaded', function() {
    // Phone number toggle
    const showPhoneBtn = document.getElementById('showPhoneNumber');
    if (showPhoneBtn) {
        showPhoneBtn.addEventListener('click', function() {
            const phoneNumberDiv = document.getElementById('phoneNumber');
            if (phoneNumberDiv) {
                phoneNumberDiv.classList.toggle('d-none');
            }
        });
    }
    
    // Contact form handling
    const contactForm = document.getElementById('contactForm');
    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            const messageBody = document.getElementById('messageBody');
            if (messageBody && messageBody.value.trim().length < 10) {
                e.preventDefault();
                alert('Please write a more detailed message (at least 10 characters).');
                messageBody.focus();
            }
        });
    }
    
    // Visit form handling
    const visitForm = document.getElementById('visitForm');
    if (visitForm) {
        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('visitDate');
        if (dateInput) {
            dateInput.min = today;
        }
        
        visitForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const date = document.getElementById('visitDate').value;
            const time = document.getElementById('visitTime').value;
            
            if (date && time) {
                alert('Visit request sent for ' + date + ' at ' + time);
                visitForm.reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleVisitModal'));
                if (modal) modal.hide();
            } else {
                alert('Please select both date and time.');
            }
        });
    }
    
    // Global function for contact requests
    window.requestContactDetails = function() {
        alert('Contact request sent. The broker will contact you shortly.');
    };
    
    // Get CSRF token function
    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return null;
    }
});
</script>
{% endblock %}